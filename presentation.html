<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>
      Synchronize MapView and SceneView | Sample | ArcGIS API for JavaScript
      4.21
    </title>

    <style>
      html,
      body {
        padding: 0;
        margin: 0;
        height: 100%;
      }
      
       #controls {
         width: 500px;
       }

       #outer-container {
         padding: 15px;
         width: 500px;
       }

       #description{
         padding: 10px 10px 0px 10px;
         font-size: 14pt;
       }

       #titleDiv {
         padding: 10px;
       }

       #titleText {
         font-size: 20pt;
         font-weight: 60;
         padding-bottom: 10px;
       }
    </style>

    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.21/esri/themes/light/main.css"
    />
    <script src="https://js.arcgis.com/4.21/"></script>

    <script>
      require([
        "esri/Map",
        "esri/views/MapView",
        "esri/views/SceneView",
        "esri/WebMap",
        "esri/WebScene",
        "esri/widgets/LayerList",
        "esri/widgets/Expand",
        "esri/widgets/Legend",
        "esri/core/watchUtils",
        "esri/core/Collection",
        "esri/widgets/HistogramRangeSlider",
        "esri/smartMapping/statistics/histogram",
        "esri/core/promiseUtils"
      ], (Map,
      MapView,
      SceneView,
      WebMap,
      WebScene,
      LayerList,
      Expand,
      Legend,
      watchUtils,
      Collection,
      HistogramRangeSlider,
      histogram,
      promiseUtils
      ) => {
        const map = new Map({
          basemap: "satellite"
        });

        const webmap = new WebMap({
          portalItem: {
            id: "4199ba17ac424967aa0e739319957fb0"
          }
        });

        const webscene = new WebScene({
          portalItem: {
            id: "936a3047186f457db20693f359ce90ae"
          }
        });
        

        const view1 = new SceneView({
          container: "view1Div",
          map: webscene
        });

        const view2 = new MapView({
          container: "view2Div",
          map: webmap,
          constraints: {
            // Disable zoom snapping to get the best synchronization
            snapToZoom: false
          }
        });
        
        let sceneLayer = new LayerList({
          view: view1,
          container: document.createElement("div")
        });
        
        let webLayer = new LayerList({
          view: view2,
          container: document.createElement("div")
        });
        


        const views = [view1, view2];
        let active;
        
         /////////////////////////////
        const sceneExpand = new Expand({
          view: view1,
          content: sceneLayer
        });
        
        const mapExpand = new Expand({
          view: view2,
          content: webLayer
        });
        
        view1.ui.add(sceneExpand, "top-right");
        
        view2.ui.add(mapExpand, "top-right");

        // close the expand whenever a basemap is selected

          /////////////////////////////


        const sync = (source) => {
          if (!active || !active.viewpoint || active !== source) {
            return;
          }

          for (const view of views) {
            if (view !== active) {
              view.viewpoint = active.viewpoint;
            }
          }
        };

        for (const view of views) {
          view.watch(["interacting", "animation"], () => {
            active = view;
            sync(active);
          });

          view.watch("viewpoint", () => sync(view));
          
        }
        
      const legend1 = new Legend ({
        view:view1,
        container: document.createElement("div")
      });

      
      const legend2 = new Legend ({
        view:view2,
        container: document.createElement("div")
      });
      
        const mapLegendExpand = new Expand({
          view: view2,
          content: legend2
        });
        
        const sceneLegendExpand = new Expand({
          view: view1,
          content: legend1
        });
        
        view1.ui.add(sceneLegendExpand, "bottom-left");
        
        view2.ui.add(mapLegendExpand, "bottom-left");
        

        // Listen to layer change events on all of map's layers
        
          const filterExpand = new Expand({
              view: view1,
              content: document.getElementById("controls"),
              expandIconClass: "esri-icon-filter",
              expanded: false
              
            });

          view1.ui.add(filterExpand, "bottom-left");
        
        var count = 0
        // Only listening to layer added event in this case.
        // Listen the view's click event.
        view1.on("pointer-move", (event) => {
          if (count===1){
            return;
          }
          count = count + 1
          console.log('test')
          const layer = webscene.layers.getItemAt(10);
          view1.whenLayerView(layer).then((layerView) => {
          const field = "bouwjaar";
          const min = 1950;
          const max = 2021;
          console.log(layer)

          histogram({
            layer: layer,
            field: field,
            numBins: 100,
            minValue: min,
            maxValue: max
          }).then((histogramResponse) => {
            const slider = new HistogramRangeSlider({
              bins: histogramResponse.bins,
              min: min,
              max: max,
              values: [min, max],
              excludedBarColor: "#524e4e",
              rangeType: "between",
              container: document.getElementById("slider-container")
            });

            slider.on(
              ["thumb-change", "thumb-drag", "segment-drag"],
              (event) => {
                filterByHistogramRange(field).catch((error) => {
                  if (error.name !== "AbortError") {
                    console.error(error);
                  }
                });
              }
            );

            const filterByHistogramRange = promiseUtils.debounce((field) => {
              layerView.filter = {
                where: slider.generateWhereClause(field)
              };
            });

          });
        });
      });


        
        
          

      });
    </script>
  </head>
  <body>
    <div id="view1Div" style="float: left; width: 50%; height: 100%">
      <div id="viewSceneDiv"></div>
      <div id="LegendSceneDiv"></div>
        <div id="controls" class="esri-widget">
          <div id="description" class="esri-widget"> <center><bold>Pand bouwjaar</bold></center> </div>
          <div id="outer-container" class="esri-widget">
            <div id="slider-container"></div>
          </div>
      </div>
    </div>
    <div id="view2Div" style="float: left; width: 50%; height: 100%">
      <div id="viewMapDiv"></div>
      <div id="LegendMapDiv"></div>
    </div>
  </body>
</html>
